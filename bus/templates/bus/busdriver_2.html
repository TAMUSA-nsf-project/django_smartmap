{% extends "main/base.html" %}
{% load static %}

{% block extend_head %}

    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', () => {

            const routeSelect = document.querySelector("#routeSelect");
            const statusMessageDiv = document.querySelector("#statusMessage")
            const latlngMessageDiv = document.querySelector("#latlngMessage")
            const broadcastFrequency = 2000;

            var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);
            let prevTime = Date.now();

            const watchPositionOptions = {
                enableHighAccuracy: true,
                timeout: broadcastFrequency,
                //maximumAge: 60000,
            };

            function geolocationPositionError (positionError) {
              console.warn('ERROR(' + positionError.code + '): ' + positionError.message);
            }

            socket.on('connect', () => {

                routeSelect.addEventListener("input", () => {

                    statusMessageDiv.innerHTML = `broadcasting position for ${routeSelect.value}`

                    const watchPositionSuccess = function (geolocationPosition) {

                        if(geolocationPosition.timestamp - prevTime > broadcastFrequency)
                        {
                            prevTime = geolocationPosition.timestamp
                            const geolocationCoordinates = geolocationPosition.coords;

                            //console.log(`Function called with ${geolocationCoordinates}`)
                            latlngMessageDiv.innerHTML = `Latitude  :${geolocationCoordinates.latitude}
                                                          Longitude :${geolocationCoordinates.longitude}
                                                          Accuracy  :${geolocationCoordinates.accuracy}
                                                          Speed     :${geolocationCoordinates.speed}`
                            // Send the location information to the server
                            socket.emit('broadcast_bus', {
                            'selected_route': routeSelect.value,
                            'bus_lat': geolocationCoordinates.latitude,
                            'bus_lng': geolocationCoordinates.longitude,
                            'bus_dir': geolocationCoordinates.heading
                        })
                        }
                        else
                        {
                            // We don't want to make frequent commits to server.
                            console.log(geolocationPosition.timestamp - prevTime)
                        }
                    };

                    navigator.geolocation.watchPosition(watchPositionSuccess, geolocationPositionError,watchPositionOptions)

                })
            })
        })

    </script>

{% endblock %}


{% block content %}
    <div class="mb-3">
        <select class="form-select" id="routeSelect">
            <option selected disabled value="">Select route...</option>
            {% for route in route_json %}
                <option value="{{ route }}">{{ route }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="mb-3" id="statusMessage"></div>
    <div class="mb-3" id="latlngMessage"></div>



{% endblock %}
