{% extends "main/base.html" %}
{% load static %}

{% block extend_head %}

    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', () => {

            const routeSelect = document.querySelector("#routeSelect");
            const statusMessageDiv = document.querySelector("#statusMessage")
            const latlngMessageDiv = document.querySelector("#latlngMessage")
            const broadcastFrequency = 2000;

            let prevTime = Date.now();

            const watchPositionOptions = {
                enableHighAccuracy: true,
                timeout: broadcastFrequency,
                //maximumAge: 60000,
            };

            function geolocationPositionError(positionError) {
                console.warn('ERROR(' + positionError.code + '): ' + positionError.message);
            }

            function ajaxSuccess(data) {
                // nothing
            }


            routeSelect.addEventListener("input", () => {

                statusMessageDiv.innerHTML = `Broadcasting position for :  ${routeSelect.options[routeSelect.selectedIndex].text}`

                const watchPositionSuccess = function (geolocationPosition) {

                    if (geolocationPosition.timestamp - prevTime > broadcastFrequency) {
                        prevTime = geolocationPosition.timestamp
                        const geolocationCoordinates = geolocationPosition.coords;

                        //console.log(`Function called with ${geolocationCoordinates}`)
                        latlngMessageDiv.innerHTML = `Latitude  :${geolocationCoordinates.latitude}
                                                      Longitude :${geolocationCoordinates.longitude}
                                                      Accuracy  :${geolocationCoordinates.accuracy}
                                                      Speed     :${geolocationCoordinates.speed}
                                                      Rotation  :${geolocationCoordinates.heading}`

                        // Send the location information to the server
                        const posData = {
                            'selected_route': routeSelect.value,
                            'latitude': geolocationCoordinates.latitude,
                            'longitude': geolocationCoordinates.longitude,
                            'accuracy': geolocationCoordinates.accuracy != null ? geolocationCoordinates.accuracy: "",
                            'speed': geolocationCoordinates.speed != null ? geolocationCoordinates.speed: "",
                            'heading': geolocationCoordinates.heading != null ? geolocationCoordinates.heading: ""
                        }

                        jQuery.ajax({
                            url: "{% url 'bus:busposition-ajax' %}",
                            data: {'posData': JSON.stringify(posData)},
                            // ^the leftmost "data" is a keyword used by ajax and is not a key that is accessible
                            // server-side, hence the object defined here
                            type: "GET",
                            //dataType: 'json', // dataType specifies the type of data expected back from the server,
                            dataType: 'html',  // in this example HTML data is sent back via HttpResponse in views.py
                            success: ajaxSuccess,
                        });

                    } else {
                        // We don't want to make frequent commits to server.
                        console.log(geolocationPosition.timestamp - prevTime)
                    }
                };

                navigator.geolocation.watchPosition(watchPositionSuccess, geolocationPositionError, watchPositionOptions)

            })
        })

    </script>

{% endblock %}


{% block content %}
    <div class="container py-4">
        <div class="mb-3">
            <select class="form-select" id="routeSelect">
                <option selected disabled value="">Select route...</option>
                {% for route_id, route_text in allRoutes.items %}
                    <option value="{{ route_id }}">{{ route_text }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="mb-3" id="statusMessage"></div>
        <div class="mb-3" id="latlngMessage"></div>
    </div>



{% endblock %}
